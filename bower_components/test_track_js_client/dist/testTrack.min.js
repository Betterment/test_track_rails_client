!function(a,b){"function"==typeof define&&define.amd?define(["node-uuid","blueimp-md5","jquery","base-64","jquery.cookie"],b):a.TestTrack=b(a.uuid,a.md5,a.jQuery,a.base64)}(this,function(a,b,c,d){"use strict";if("undefined"==typeof a)throw new Error('TestTrack depends on node-uuid. Make sure you are including "bower_components/node-uuid/uuid.js"');if("undefined"==typeof b)throw new Error('TestTrack depends on blueimp-md5. Make sure you are including "bower_components/blueimp-md5/js/md5.js"');if("undefined"==typeof c)throw new Error('TestTrack depends on jquery. You can use your own copy of jquery or the one in "bower_components/jquery/dist/jquery.js"');if("function"!=typeof c.cookie)throw new Error("TestTrack depends on jquery.cookie. You can user your own copy of jquery.cooke or the one in bower_components/jquery.cookie/jquery.cookie.js");if("undefined"==typeof d)throw new Error('TestTrack depends on base-64. Make sure you are including "bower_components/base-64/base64.js"');var e=function(){var a=function(){};return a.prototype.getConfig=function(){return"function"==typeof window.atob?JSON.parse(window.atob(window.TT)):JSON.parse(d.decode(window.TT))},a}(),f=function(){var a,b=function(){if(!a){var b=new e;a=b.getConfig()}return a};return{getUrl:function(){return b().url},getCookieDomain:function(){return b().cookieDomain},getSplitRegistry:function(){return b().registry},getAssignmentRegistry:function(){return b().assignments}}}(),g=function(){var a=function(a){if(this.visitor=a.visitor,this.splitName=a.splitName,!this.visitor)throw new Error("must provide visitor");if(!this.splitName)throw new Error("must provide splitName")};return a.prototype.getVariant=function(){if(!f.getSplitRegistry())return null;for(var a=0,b=this.getAssignmentBucket(),c=this.getWeighting(),d=this.getSortedVariants(),e=0;e<d.length;e++){var g=d[e];if(a+=c[g],a>b)return g}throw new Error("Assignment bucket out of range. "+b+" unmatched in "+this.splitName+": "+JSON.stringify(c))},a.prototype.getSplitVisitorHash=function(){return b(this.splitName+this.visitor.getId())},a.prototype.getHashFixnum=function(){return parseInt(this.getSplitVisitorHash().substr(0,8),16)},a.prototype.getAssignmentBucket=function(){return this.getHashFixnum()%100},a.prototype.getSortedVariants=function(){return this.getVariants().sort()},a.prototype.getVariants=function(){return Object.getOwnPropertyNames(this.getWeighting())},a.prototype.getWeighting=function(){var a=f.getSplitRegistry()[this.splitName];if(!a){var b='Unknown split: "'+this.splitName+'"';throw this.visitor.logError(b),new Error(b)}return a},a}(),h=function(){var a=function(a){if(this.visitor=a.visitor,this.splitName=a.splitName,this.variant=a.variant,!this.visitor)throw new Error("must provide visitor");if(!this.splitName)throw new Error("must provide splitName");if(!this.variant)throw new Error("must provide variant")};return a.prototype.send=function(){this.persistAssignment(),window.mixpanel.track("SplitAssigned",{TTVisitorID:this.visitor.getId(),SplitName:this.splitName,SplitVariant:this.variant},function(a){this.persistAssignment(a?"success":"failure")}.bind(this))},a.prototype.persistAssignment=function(a){return c.ajax(f.getUrl()+"/api/assignment",{method:"POST",dataType:"json",crossDomain:!0,data:{visitor_id:this.visitor.getId(),split:this.splitName,variant:this.variant,mixpanel_result:a}}).fail(function(a,b,c){var d=a&&a.status,e=a&&a.responseText;this.visitor.logError("test_track persistAssignment error: "+[a,d,e,b,c].join(", "))}.bind(this))},a}(),i=function(){var b=function(a){if(a=a||{},this._id=a.id,this._assignmentRegistry=a.assignmentRegistry,this._unsyncedSplits=a.unsyncedSplits,this._ttOffline=a.ttOffline,!this._id)throw new Error("must provide id");if(!this._assignmentRegistry)throw new Error("must provide assignmentRegistry");if(!this._unsyncedSplits)throw new Error("must provide unsyncedSplits");this._notifyUnsyncedAssignments(),this._errorLogger=function(a){window.console.error(a)}};return b.loadVisitor=function(b){var d=c.Deferred(),e=function(a){d.resolve(new i(a))};return b?f.getAssignmentRegistry()?e({id:b,assignmentRegistry:f.getAssignmentRegistry(),unsyncedSplits:[],ttOffline:!1}):c.ajax(f.getUrl()+"/api/visitors/"+b,{method:"GET",timeout:5e3}).done(function(a){e({id:a.id,assignmentRegistry:a.assignment_registry,unsyncedSplits:a.unsynced_splits,ttOffline:!1})}).fail(function(){e({id:b,assignmentRegistry:{},unsyncedSplits:[],ttOffline:!0})}):e({id:a.v4(),assignmentRegistry:{},unsyncedSplits:[],ttOffline:!1}),d.promise()},b.prototype.getId=function(){return this._id},b.prototype.getAssignmentRegistry=function(){return this._assignmentRegistry},b.prototype.getUnsyncedSplits=function(){return this._unsyncedSplits},b.prototype.vary=function(a,b,c){if("object"!=typeof b)throw new Error("must provide configuration object to `vary` for "+a);if(!c&&c!==!1)throw new Error("must provide defaultVariant to `vary` for "+a);if(c=c.toString(),!b.hasOwnProperty(c))throw new Error("defaultVariant: "+c+" must be represented in configuration object");var d=this._getAssignmentFor(a),e=new l({splitName:a,assignedVariant:d,visitor:this});for(var d in b)b.hasOwnProperty(d)&&(d===c?e["default"](d,b[d]):e.when(d,b[d]));e.run(),e.isDefaulted()&&this._assignTo(a,e.getDefaultVariant()),this._newAssignedVariant&&(this._notify(a,this._newAssignedVariant),delete this._newAssignedVariant)},b.prototype.ab=function(a,b,c){"function"==typeof b&&(c=b,b=null);var d=new m({splitName:a,trueVariant:b,visitor:this}),e=d.getVariants(),f={};f[e["true"]]=function(){c(!0)},f[e["false"]]=function(){c(!1)},this.vary(a,f,e["false"])},b.prototype.setErrorLogger=function(a){if("function"!=typeof a)throw new Error("must provide function for errorLogger");this._errorLogger=a},b.prototype.logError=function(a){this._errorLogger.call(null,a)},b.prototype.linkIdentifier=function(a,b){var d=c.Deferred(),e=new k({visitorId:this.getId(),identifierType:a,value:b});return e.save().then(function(a){this._merge(a),d.resolve()}.bind(this)),d.promise()},b.prototype._merge=function(a){var b=this.getAssignmentRegistry(),c=a.getAssignmentRegistry();this._id=a.getId();for(var d in c)c.hasOwnProperty(d)&&(b[d]=c[d])},b.prototype._notifyUnsyncedAssignments=function(){for(var a=0;a<this.getUnsyncedSplits().length;a++){var b=this.getUnsyncedSplits()[a];this._notify(b,this.getAssignmentRegistry()[b])}this._unsyncedSplits=[]},b.prototype._getAssignmentFor=function(a){return this.getAssignmentRegistry()[a]||this._generateAssignmentFor(a)},b.prototype._generateAssignmentFor=function(a){var b=new g({visitor:this,splitName:a}).getVariant();return b||(this._ttOffline=!0),this._assignTo(a,b),b},b.prototype._assignTo=function(a,b){this._ttOffline||(this.getAssignmentRegistry()[a]=b,this._newAssignedVariant=b)},b.prototype._notify=function(a,b){try{var c=new h({visitor:this,splitName:a,variant:b});c.send()}catch(d){this.logError("test_track notify error: "+d)}},b}(),j=function(){var a="tt_visitor_id",b=function(){var b=c.cookie(a),d=c.Deferred();this._visitorPromise=d.promise(),i.loadVisitor(b).then(function(a){d.resolve(a)}),this._setCookie()};return b.prototype.vary=function(a,b,c){this._visitorPromise.then(function(d){d.vary(a,b,c)})},b.prototype.ab=function(a,b,c){this._visitorPromise.then(function(d){d.ab(a,b,c)})},b.prototype.logIn=function(a,b){var d=c.Deferred();return this._visitorPromise.then(function(c){c.linkIdentifier(a,b).then(function(){this._setCookie(),window.mixpanel.identify(c.getId()),d.resolve()}.bind(this))}.bind(this)),d.promise()},b.prototype.signUp=function(a,b){var d=c.Deferred();return this._visitorPromise.then(function(c){c.linkIdentifier(a,b).then(function(){this._setCookie(),window.mixpanel.alias(c.getId()),d.resolve()}.bind(this))}.bind(this)),d.promise()},b.prototype.setErrorLogger=function(a){this._visitorPromise.then(function(b){b.setErrorLogger(a)})},b.prototype._setCookie=function(){this._visitorPromise.then(function(b){c.cookie(a,b.getId(),{expires:365,path:"/",domain:f.getCookieDomain()})})},b.prototype.getPublicAPI=function(){return{vary:this.vary.bind(this),ab:this.ab.bind(this),logIn:this.logIn.bind(this),signUp:this.signUp.bind(this),setErrorLogger:this.setErrorLogger.bind(this),_crx:{loadInfo:function(){var a=c.Deferred();return this._visitorPromise.then(function(b){a.resolve({visitorId:b.getId(),splitRegistry:f.getSplitRegistry(),assignmentRegistry:b.getAssignmentRegistry()})}),a.promise()}.bind(this),persistAssignment:function(a,b){var d=c.Deferred();return this._visitorPromise.then(function(c){var e=new h({visitor:c,splitName:a,variant:b});e.persistAssignment().then(function(){d.resolve()})}),d.promise()}.bind(this)}}},b}(),k=function(){var a=function(a){if(this.visitorId=a.visitorId,this.identifierType=a.identifierType,this.value=a.value,!this.visitorId)throw new Error("must provide visitorId");if(!this.identifierType)throw new Error("must provide identifierType");if(!this.value)throw new Error("must provide value")};return a.prototype.save=function(a,b){var d=c.Deferred();return c.ajax(f.getUrl()+"/api/identifier",{method:"POST",dataType:"json",crossDomain:!0,data:{identifier_type:this.identifierType,value:this.value,visitor_id:this.visitorId}}).then(function(a){var b=new i({id:a.visitor.id,assignmentRegistry:a.visitor.assignment_registry,unsyncedSplits:a.visitor.unsynced_splits});d.resolve(b)}),d.promise()},a}(),l=function(){var a=function(a){if(!a.splitName)throw new Error("must provide splitName");if(!a.hasOwnProperty("assignedVariant"))throw new Error("must provide assignedVariant");if(!a.visitor)throw new Error("must provide visitor");this._splitName=a.splitName,this._assignedVariant=a.assignedVariant,this._visitor=a.visitor,this._splitRegistry=f.getSplitRegistry(),this._variantHandlers={}};return a.prototype.when=function(){var a=Array.prototype.slice.call(arguments,0),b=a.length-1,c="function"!=typeof a[0]&&a.length>0,d=c?a.slice(0,Math.max(1,b)):[],e=a[b];if(0===d.length)throw new Error("must provide at least one variant");for(var f=0;f<d.length;f++)this._assignHandlerToVariant(d[f],e)},a.prototype["default"]=function(a,b){if(this._defaultVariant)throw new Error("must provide exactly one `default`");this._defaultVariant=this._assignHandlerToVariant(a,b)},a.prototype.run=function(){this._validate();var a;this._variantHandlers[this._assignedVariant]?a=this._variantHandlers[this._assignedVariant]:(a=this._variantHandlers[this.getDefaultVariant()],this._defaulted=!0),a()},a.prototype.isDefaulted=function(){return this._defaulted||!1},a.prototype.getDefaultVariant=function(){return this._defaultVariant},a.prototype._assignHandlerToVariant=function(a,b){if("function"!=typeof b)throw new Error("must provide handler for "+a);return a=a.toString(),this._getSplit()&&!this._getSplit().hasOwnProperty(a)&&this._visitor.logError("configures unknown variant "+a),this._variantHandlers[a]=b,a},a.prototype._validate=function(){if(!this.getDefaultVariant())throw new Error("must provide exactly one `default`");if(this._getVariants().length<2)throw new Error("must provide at least one `when`");if(this._getSplit()){var a=this._getMissingVariants();if(a.length>0){var b=a.join(", ").replace(/, (.+)$/," and $1");this._visitor.logError("does not configure variants "+b)}}},a.prototype._getSplit=function(){return this._splitRegistry?this._splitRegistry[this._splitName]:null},a.prototype._getVariants=function(){return Object.getOwnPropertyNames(this._variantHandlers)},a.prototype._getMissingVariants=function(){for(var a=this._getVariants(),b=this._getSplit(),c=Object.getOwnPropertyNames(b),d=[],e=0;e<c.length;e++){var f=c[e];-1===a.indexOf(f)&&d.push(f)}return d},a}(),m=function(){var a=function(a){if(!a.splitName)throw new Error("must provide splitName");if(!a.hasOwnProperty("trueVariant"))throw new Error("must provide trueVariant");if(!a.visitor)throw new Error("must provide visitor");this._splitName=a.splitName,this._trueVariant=a.trueVariant,this._visitor=a.visitor,this._splitRegistry=f.getSplitRegistry()};return a.prototype.getVariants=function(){var a=this._getSplitVariants();return a&&a.length>2&&this._visitor.logError("A/B for "+this._splitName+" configures split with more than 2 variants"),{"true":this._getTrueVariant(),"false":this._getFalseVariant()}},a.prototype._getTrueVariant=function(){return this._trueVariant||!0},a.prototype._getFalseVariant=function(){var a=this._getNonTrueVariants();return a?a.sort()[0]:!1},a.prototype._getNonTrueVariants=function(){var a=this._getSplitVariants();if(a){var b=this._getTrueVariant(),c=a.indexOf(b);return-1!==c&&a.splice(c,1),a}return null},a.prototype._getSplit=function(){return this._splitRegistry?this._splitRegistry[this._splitName]:null},a.prototype._getSplitVariants=function(){return this._getSplit()&&Object.getOwnPropertyNames(this._getSplit())},a}(),n=(new j).getPublicAPI(),o=function(){window.dispatchEvent(new CustomEvent("tt:lib:loaded",{detail:{TestTrack:n}}))};try{c(document).ready(function(){c(document.body).addClass("_tt");try{window.dispatchEvent(new CustomEvent("tt:class:added"))}catch(a){}}),o(),window.addEventListener("tt:listener:ready",o)}catch(p){}return n});